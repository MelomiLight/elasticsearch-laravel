# Movie Search API

Laravel-Ð¿Ñ€Ð¸Ð»Ð¾Ð¶ÐµÐ½Ð¸Ðµ Ð´Ð»Ñ Ð¿Ð¾Ð¸ÑÐºÐ° Ñ„Ð¸Ð»ÑŒÐ¼Ð¾Ð² Ñ Ð¸ÑÐ¿Ð¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ð½Ð¸ÐµÐ¼ Elasticsearch. ÐŸÑ€Ð¸Ð»Ð¾Ð¶ÐµÐ½Ð¸Ðµ Ð¸Ð½Ñ‚ÐµÐ³Ñ€Ð¸Ñ€ÑƒÐµÑ‚ÑÑ Ñ TMDb API Ð´Ð»Ñ Ð¸Ð¼Ð¿Ð¾Ñ€Ñ‚Ð° Ð´Ð°Ð½Ð½Ñ‹Ñ… Ð¾ Ñ„Ð¸Ð»ÑŒÐ¼Ð°Ñ… Ð¸ Ð¶Ð°Ð½Ñ€Ð°Ñ….

## Ð’Ð¾Ð·Ð¼Ð¾Ð¶Ð½Ð¾ÑÑ‚Ð¸

- ðŸ” ÐŸÐ¾Ð»Ð½Ð¾Ñ‚ÐµÐºÑÑ‚Ð¾Ð²Ñ‹Ð¹ Ð¿Ð¾Ð¸ÑÐº Ñ„Ð¸Ð»ÑŒÐ¼Ð¾Ð² Ð¿Ð¾ Ð½Ð°Ð·Ð²Ð°Ð½Ð¸ÑŽ, Ð¾Ð¿Ð¸ÑÐ°Ð½Ð¸ÑŽ Ð¸ Ð¶Ð°Ð½Ñ€Ð°Ð¼
- ðŸ“Š Ð’Ð·Ð²ÐµÑˆÐµÐ½Ð½Ñ‹Ð¹ Ð¿Ð¾Ð¸ÑÐº Ñ Ð½Ð°ÑÑ‚Ñ€Ð°Ð¸Ð²Ð°ÐµÐ¼Ñ‹Ð¼Ð¸ ÐºÐ¾ÑÑ„Ñ„Ð¸Ñ†Ð¸ÐµÐ½Ñ‚Ð°Ð¼Ð¸ Ñ€ÐµÐ»ÐµÐ²Ð°Ð½Ñ‚Ð½Ð¾ÑÑ‚Ð¸
- ðŸŽ¬ Ð˜Ð½Ñ‚ÐµÐ³Ñ€Ð°Ñ†Ð¸Ñ Ñ TMDb API Ð´Ð»Ñ Ð¸Ð¼Ð¿Ð¾Ñ€Ñ‚Ð° Ð¿Ð¾Ð¿ÑƒÐ»ÑÑ€Ð½Ñ‹Ñ… Ñ„Ð¸Ð»ÑŒÐ¼Ð¾Ð²
- ðŸ·ï¸ ÐŸÐ¾Ð´Ð´ÐµÑ€Ð¶ÐºÐ° Ð¿Ð¾Ð¸ÑÐºÐ° Ð¿Ð¾ ÑÐ²ÑÐ·Ð°Ð½Ð½Ñ‹Ð¼ Ð¶Ð°Ð½Ñ€Ð°Ð¼
- âš¡ ÐÐ²Ñ‚Ð¾Ð¼Ð°Ñ‚Ð¸Ñ‡ÐµÑÐºÐ°Ñ Ð¸Ð½Ð´ÐµÐºÑÐ°Ñ†Ð¸Ñ Ð² Elasticsearch Ð¿Ñ€Ð¸ ÑÐ¾Ð·Ð´Ð°Ð½Ð¸Ð¸/Ð¾Ð±Ð½Ð¾Ð²Ð»ÐµÐ½Ð¸Ð¸ Ð·Ð°Ð¿Ð¸ÑÐµÐ¹
- ðŸ“„ ÐŸÐ°Ð³Ð¸Ð½Ð°Ñ†Ð¸Ñ Ñ€ÐµÐ·ÑƒÐ»ÑŒÑ‚Ð°Ñ‚Ð¾Ð² Ð¿Ð¾Ð¸ÑÐºÐ°

## Ð¢Ñ€ÐµÐ±Ð¾Ð²Ð°Ð½Ð¸Ñ

- PHP 8.1+
- Laravel 10+
- Elasticsearch 7.x/8.x
- Composer

## Ð£ÑÑ‚Ð°Ð½Ð¾Ð²ÐºÐ°

### 1. ÐšÐ»Ð¾Ð½Ð¸Ñ€Ð¾Ð²Ð°Ð½Ð¸Ðµ Ð¸ ÑƒÑÑ‚Ð°Ð½Ð¾Ð²ÐºÐ° Ð·Ð°Ð²Ð¸ÑÐ¸Ð¼Ð¾ÑÑ‚ÐµÐ¹

```bash
git clone https://github.com/MelomiLight/elasticsearch-laravel.git
cd movie-search-api
composer install
```

### 2. ÐÐ°ÑÑ‚Ñ€Ð¾Ð¹ÐºÐ° Ð¾ÐºÑ€ÑƒÐ¶ÐµÐ½Ð¸Ñ

Ð¡ÐºÐ¾Ð¿Ð¸Ñ€ÑƒÐ¹Ñ‚Ðµ Ñ„Ð°Ð¹Ð» Ð¾ÐºÑ€ÑƒÐ¶ÐµÐ½Ð¸Ñ Ð¸ Ð½Ð°ÑÑ‚Ñ€Ð¾Ð¹Ñ‚Ðµ Ð¿ÐµÑ€ÐµÐ¼ÐµÐ½Ð½Ñ‹Ðµ:

```bash
cp .env.example .env
php artisan key:generate
```

### 3. ÐÐ°ÑÑ‚Ñ€Ð¾Ð¹ÐºÐ° Ð¿ÐµÑ€ÐµÐ¼ÐµÐ½Ð½Ñ‹Ñ… Ð¾ÐºÑ€ÑƒÐ¶ÐµÐ½Ð¸Ñ

Ð”Ð¾Ð±Ð°Ð²ÑŒÑ‚Ðµ Ð² `.env` Ñ„Ð°Ð¹Ð» ÑÐ»ÐµÐ´ÑƒÑŽÑ‰Ð¸Ðµ Ð¿ÐµÑ€ÐµÐ¼ÐµÐ½Ð½Ñ‹Ðµ:

```env
# Elasticsearch
ELASTICSEARCH_HOST=http://localhost:9200

# TMDb API
TMDB_API_KEY=your_tmdb_api_key_here

# Database
DB_CONNECTION=mysql
DB_HOST=127.0.0.1
DB_PORT=3306
DB_DATABASE=movie_search
DB_USERNAME=your_username
DB_PASSWORD=your_password
```

### 4. ÐÐ°ÑÑ‚Ñ€Ð¾Ð¹ÐºÐ° Ð±Ð°Ð·Ñ‹ Ð´Ð°Ð½Ð½Ñ‹Ñ…

```bash
php artisan migrate
```

### 5. Ð—Ð°Ð¿ÑƒÑÐº Elasticsearch

Ð£Ð±ÐµÐ´Ð¸Ñ‚ÐµÑÑŒ, Ñ‡Ñ‚Ð¾ Elasticsearch Ð·Ð°Ð¿ÑƒÑ‰ÐµÐ½ Ð¸ Ð´Ð¾ÑÑ‚ÑƒÐ¿ÐµÐ½ Ð¿Ð¾ Ð°Ð´Ñ€ÐµÑÑƒ, ÑƒÐºÐ°Ð·Ð°Ð½Ð½Ð¾Ð¼Ñƒ Ð² `ELASTICSEARCH_HOST`.

## Ð˜ÑÐ¿Ð¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ð½Ð¸Ðµ

### Ð˜Ð¼Ð¿Ð¾Ñ€Ñ‚ Ð´Ð°Ð½Ð½Ñ‹Ñ…

#### Ð˜Ð¼Ð¿Ð¾Ñ€Ñ‚ Ð¶Ð°Ð½Ñ€Ð¾Ð² Ð¸Ð· TMDb:

```bash
php artisan genres:import
```

#### Ð˜Ð¼Ð¿Ð¾Ñ€Ñ‚ Ð¿Ð¾Ð¿ÑƒÐ»ÑÑ€Ð½Ñ‹Ñ… Ñ„Ð¸Ð»ÑŒÐ¼Ð¾Ð² Ð¸Ð· TMDb:

```bash
php artisan movies:import-popular
```

Ð­Ñ‚Ð° ÐºÐ¾Ð¼Ð°Ð½Ð´Ð° Ð¸Ð¼Ð¿Ð¾Ñ€Ñ‚Ð¸Ñ€ÑƒÐµÑ‚ Ð¿ÐµÑ€Ð²Ñ‹Ðµ 10 ÑÑ‚Ñ€Ð°Ð½Ð¸Ñ† Ð¿Ð¾Ð¿ÑƒÐ»ÑÑ€Ð½Ñ‹Ñ… Ñ„Ð¸Ð»ÑŒÐ¼Ð¾Ð² (~200 Ñ„Ð¸Ð»ÑŒÐ¼Ð¾Ð²).

### API Endpoints

#### ÐŸÐ¾Ð¸ÑÐº Ñ„Ð¸Ð»ÑŒÐ¼Ð¾Ð²

```http
GET /api/V1/movies/search
```

**ÐŸÐ°Ñ€Ð°Ð¼ÐµÑ‚Ñ€Ñ‹ Ð·Ð°Ð¿Ñ€Ð¾ÑÐ°:**

- `query` (string, Ð¾Ð±ÑÐ·Ð°Ñ‚ÐµÐ»ÑŒÐ½Ñ‹Ð¹) - Ð¿Ð¾Ð¸ÑÐºÐ¾Ð²Ñ‹Ð¹ Ð·Ð°Ð¿Ñ€Ð¾Ñ
- `page` (integer, Ð¾Ð¿Ñ†Ð¸Ð¾Ð½Ð°Ð»ÑŒÐ½Ñ‹Ð¹) - Ð½Ð¾Ð¼ÐµÑ€ ÑÑ‚Ñ€Ð°Ð½Ð¸Ñ†Ñ‹ (Ð¿Ð¾ ÑƒÐ¼Ð¾Ð»Ñ‡Ð°Ð½Ð¸ÑŽ: 1)
- `perPage` (integer, Ð¾Ð¿Ñ†Ð¸Ð¾Ð½Ð°Ð»ÑŒÐ½Ñ‹Ð¹) - ÐºÐ¾Ð»Ð¸Ñ‡ÐµÑÑ‚Ð²Ð¾ Ñ€ÐµÐ·ÑƒÐ»ÑŒÑ‚Ð°Ñ‚Ð¾Ð² Ð½Ð° ÑÑ‚Ñ€Ð°Ð½Ð¸Ñ†Ðµ (Ð¿Ð¾ ÑƒÐ¼Ð¾Ð»Ñ‡Ð°Ð½Ð¸ÑŽ: 10)

**ÐŸÑ€Ð¸Ð¼ÐµÑ€ Ð·Ð°Ð¿Ñ€Ð¾ÑÐ°:**

```bash
curl "http://localhost:8000/api/V1/movies/search?query=spider&page=1&perPage=5"
```

**ÐŸÑ€Ð¸Ð¼ÐµÑ€ Ð¾Ñ‚Ð²ÐµÑ‚Ð°:**

```json
{
  "data": {
    "movies": [
      {
        "id": 1,
        "tmdb_id": 557,
        "title": "Spider-Man",
        "overview": "After being bitten by a genetically altered spider...",
        "release_date": "2002-05-01",
        "poster_path": "/gh4cZbhZxyTbgxQPxD0dOudNPTn.jpg",
        "vote_average": 7.2,
        "vote_count": 13507,
        "genres": [
          {
            "id": 1,
            "name": "Action"
          },
          {
            "id": 2,
            "name": "Fantasy"
          }
        ]
      }
    ]
  }
}
```

## ÐÑ€Ñ…Ð¸Ñ‚ÐµÐºÑ‚ÑƒÑ€Ð° Ð¿Ð¾Ð¸ÑÐºÐ°

### ÐŸÐ¾Ð¸ÑÐºÐ¾Ð²Ñ‹Ðµ Ð¿Ð¾Ð»Ñ Ð¸ Ð²ÐµÑÐ°

ÐŸÐ¾Ð¸ÑÐº Ð²Ñ‹Ð¿Ð¾Ð»Ð½ÑÐµÑ‚ÑÑ Ð¿Ð¾ ÑÐ»ÐµÐ´ÑƒÑŽÑ‰Ð¸Ð¼ Ð¿Ð¾Ð»ÑÐ¼ Ñ ÑƒÐºÐ°Ð·Ð°Ð½Ð½Ñ‹Ð¼Ð¸ Ð²ÐµÑÐ°Ð¼Ð¸:

- `title` (Ð²ÐµÑ: 3) - Ð½Ð°Ð·Ð²Ð°Ð½Ð¸Ðµ Ñ„Ð¸Ð»ÑŒÐ¼Ð°
- `overview` (Ð²ÐµÑ: 1) - Ð¾Ð¿Ð¸ÑÐ°Ð½Ð¸Ðµ Ñ„Ð¸Ð»ÑŒÐ¼Ð°
- `genres.name` (Ð²ÐµÑ: 2) - Ð½Ð°Ð·Ð²Ð°Ð½Ð¸Ñ Ð¶Ð°Ð½Ñ€Ð¾Ð²

### ÐÐ²Ñ‚Ð¾Ð¼Ð°Ñ‚Ð¸Ñ‡ÐµÑÐºÐ°Ñ Ð¸Ð½Ð´ÐµÐºÑÐ°Ñ†Ð¸Ñ

ÐŸÑ€Ð¸Ð»Ð¾Ð¶ÐµÐ½Ð¸Ðµ Ð¸ÑÐ¿Ð¾Ð»ÑŒÐ·ÑƒÐµÑ‚ trait `ESearchable`, ÐºÐ¾Ñ‚Ð¾Ñ€Ñ‹Ð¹ Ð°Ð²Ñ‚Ð¾Ð¼Ð°Ñ‚Ð¸Ñ‡ÐµÑÐºÐ¸:

- Ð˜Ð½Ð´ÐµÐºÑÐ¸Ñ€ÑƒÐµÑ‚ Ð¼Ð¾Ð´ÐµÐ»Ð¸ Ð² Elasticsearch Ð¿Ñ€Ð¸ ÑÐ¾Ñ…Ñ€Ð°Ð½ÐµÐ½Ð¸Ð¸
- Ð£Ð´Ð°Ð»ÑÐµÑ‚ Ð´Ð¾ÐºÑƒÐ¼ÐµÐ½Ñ‚Ñ‹ Ð¸Ð· Ð¸Ð½Ð´ÐµÐºÑÐ° Ð¿Ñ€Ð¸ ÑƒÐ´Ð°Ð»ÐµÐ½Ð¸Ð¸ Ð¼Ð¾Ð´ÐµÐ»ÐµÐ¹
- Ð˜ÑÐ¿Ð¾Ð»ÑŒÐ·ÑƒÐµÑ‚ Laravel Jobs Ð´Ð»Ñ Ð°ÑÐ¸Ð½Ñ…Ñ€Ð¾Ð½Ð½Ð¾Ð¹ Ð¾Ð±Ñ€Ð°Ð±Ð¾Ñ‚ÐºÐ¸

### Ð¡Ñ‚Ñ€ÑƒÐºÑ‚ÑƒÑ€Ð° Ð¸Ð½Ð´ÐµÐºÑÐ°

ÐšÐ°Ð¶Ð´Ñ‹Ð¹ Ñ„Ð¸Ð»ÑŒÐ¼ Ð¸Ð½Ð´ÐµÐºÑÐ¸Ñ€ÑƒÐµÑ‚ÑÑ Ð² Elasticsearch ÑÐ¾ ÑÐ»ÐµÐ´ÑƒÑŽÑ‰ÐµÐ¹ ÑÑ‚Ñ€ÑƒÐºÑ‚ÑƒÑ€Ð¾Ð¹:

```json
{
  "title": "Spider-Man",
  "overview": "After being bitten by a genetically altered spider...",
  "genres": [
    {"name": "Action"},
    {"name": "Fantasy"}
  ]
}
```

## ÐœÐ¾Ð´ÐµÐ»Ð¸

### Movie

ÐžÑÐ½Ð¾Ð²Ð½Ð°Ñ Ð¼Ð¾Ð´ÐµÐ»ÑŒ Ñ„Ð¸Ð»ÑŒÐ¼Ð° Ñ Ð¿Ð¾Ð»ÑÐ¼Ð¸:

- `tmdb_id` - ID Ñ„Ð¸Ð»ÑŒÐ¼Ð° Ð² TMDb
- `title` - Ð½Ð°Ð·Ð²Ð°Ð½Ð¸Ðµ
- `overview` - Ð¾Ð¿Ð¸ÑÐ°Ð½Ð¸Ðµ
- `release_date` - Ð´Ð°Ñ‚Ð° Ð²Ñ‹Ñ…Ð¾Ð´Ð°
- `poster_path` - Ð¿ÑƒÑ‚ÑŒ Ðº Ð¿Ð¾ÑÑ‚ÐµÑ€Ñƒ
- `vote_average` - ÑÑ€ÐµÐ´Ð½ÑÑ Ð¾Ñ†ÐµÐ½ÐºÐ°
- `vote_count` - ÐºÐ¾Ð»Ð¸Ñ‡ÐµÑÑ‚Ð²Ð¾ Ð³Ð¾Ð»Ð¾ÑÐ¾Ð²

### Genre

ÐœÐ¾Ð´ÐµÐ»ÑŒ Ð¶Ð°Ð½Ñ€Ð°:

- `tmdb_id` - ID Ð¶Ð°Ð½Ñ€Ð° Ð² TMDb
- `name` - Ð½Ð°Ð·Ð²Ð°Ð½Ð¸Ðµ Ð¶Ð°Ð½Ñ€Ð°

## ÐšÐ¾Ð½Ñ„Ð¸Ð³ÑƒÑ€Ð°Ñ†Ð¸Ñ

### Elasticsearch

ÐÐ°ÑÑ‚Ñ€Ð¾Ð¹ÐºÐ¸ Elasticsearch Ð½Ð°Ñ…Ð¾Ð´ÑÑ‚ÑÑ Ð² `config/services.php`:

```php
'elasticsearch' => [
    'hosts' => [
        env('ELASTICSEARCH_HOST', 'http://localhost:9200')
    ],
],
```

### ÐÐ°ÑÑ‚Ñ€Ð¾Ð¹ÐºÐ° Ð¿Ð¾Ð¸ÑÐºÐ°

Ð”Ð»Ñ Ð½Ð°ÑÑ‚Ñ€Ð¾Ð¹ÐºÐ¸ Ð¿Ð¾Ð¸ÑÐºÐ¾Ð²Ñ‹Ñ… Ð¿Ð¾Ð»ÐµÐ¹ Ð¸ Ð¸Ñ… Ð²ÐµÑÐ¾Ð² Ð¾Ñ‚Ñ€ÐµÐ´Ð°ÐºÑ‚Ð¸Ñ€ÑƒÐ¹Ñ‚Ðµ ÑÐ²Ð¾Ð¹ÑÑ‚Ð²Ð° Ð² Ð¼Ð¾Ð´ÐµÐ»Ð¸ `Movie`:

```php
protected static array $esSearchableFields = [
    'title' => 3,        // Ð’ÐµÑ Ð´Ð»Ñ Ð½Ð°Ð·Ð²Ð°Ð½Ð¸Ñ
    'overview' => 1,     // Ð’ÐµÑ Ð´Ð»Ñ Ð¾Ð¿Ð¸ÑÐ°Ð½Ð¸Ñ
];

protected static array $esSearchableRelations = [
    'genres' => [
        'name' => 2,     // Ð’ÐµÑ Ð´Ð»Ñ Ð½Ð°Ð·Ð²Ð°Ð½Ð¸Ð¹ Ð¶Ð°Ð½Ñ€Ð¾Ð²
    ],
];
```

## Ð Ð°Ð·Ñ€Ð°Ð±Ð¾Ñ‚ÐºÐ°

### Ð—Ð°Ð¿ÑƒÑÐº Ð¾Ñ‡ÐµÑ€ÐµÐ´ÐµÐ¹

Ð”Ð»Ñ Ð¾Ð±Ñ€Ð°Ð±Ð¾Ñ‚ÐºÐ¸ Ð·Ð°Ð´Ð°Ð½Ð¸Ð¹ Ð¸Ð½Ð´ÐµÐºÑÐ°Ñ†Ð¸Ð¸ Ð·Ð°Ð¿ÑƒÑÑ‚Ð¸Ñ‚Ðµ worker:

```bash
php artisan queue:work
```

### Ð¢ÐµÑÑ‚Ð¸Ñ€Ð¾Ð²Ð°Ð½Ð¸Ðµ

```bash
php artisan test
```

## Ð£ÑÑ‚Ñ€Ð°Ð½ÐµÐ½Ð¸Ðµ Ð½ÐµÐ¿Ð¾Ð»Ð°Ð´Ð¾Ðº

### Elasticsearch Ð½ÐµÐ´Ð¾ÑÑ‚ÑƒÐ¿ÐµÐ½

Ð£Ð±ÐµÐ´Ð¸Ñ‚ÐµÑÑŒ, Ñ‡Ñ‚Ð¾:

1. Elasticsearch Ð·Ð°Ð¿ÑƒÑ‰ÐµÐ½ Ð¸ Ð´Ð¾ÑÑ‚ÑƒÐ¿ÐµÐ½
2. ÐŸÑ€Ð°Ð²Ð¸Ð»ÑŒÐ½Ð¾ ÑƒÐºÐ°Ð·Ð°Ð½ `ELASTICSEARCH_HOST` Ð² `.env`
3. ÐÐµÑ‚ Ð¾Ð³Ñ€Ð°Ð½Ð¸Ñ‡ÐµÐ½Ð¸Ð¹ Ñ„Ð°Ð¹Ñ€Ð²Ð¾Ð»Ð°

### ÐžÑˆÐ¸Ð±ÐºÐ¸ Ð¸Ð½Ð´ÐµÐºÑÐ°Ñ†Ð¸Ð¸

ÐŸÑ€Ð¾Ð²ÐµÑ€ÑŒÑ‚Ðµ Ð»Ð¾Ð³Ð¸ Laravel:

```bash
tail -f storage/logs/laravel.log
```

### ÐŸÐµÑ€ÐµÑÐ¾Ð·Ð´Ð°Ð½Ð¸Ðµ Ð¸Ð½Ð´ÐµÐºÑÐ°

Ð•ÑÐ»Ð¸ Ð½ÑƒÐ¶Ð½Ð¾ Ð¿ÐµÑ€ÐµÑÐ¾Ð·Ð´Ð°Ñ‚ÑŒ Ð¸Ð½Ð´ÐµÐºÑ Elasticsearch:

```bash
# Ð£Ð´Ð°Ð»Ð¸Ñ‚ÑŒ Ð¸Ð½Ð´ÐµÐºÑ (Ð·Ð°Ð¼ÐµÐ½Ð¸Ñ‚Ðµ 'movies' Ð½Ð° Ð¸Ð¼Ñ Ð²Ð°ÑˆÐµÐ³Ð¾ Ð¸Ð½Ð´ÐµÐºÑÐ°)
curl -X DELETE "localhost:9200/movies"

# ÐŸÐµÑ€ÐµÐ¸Ð½Ð´ÐµÐºÑÐ¸Ñ€Ð¾Ð²Ð°Ñ‚ÑŒ Ð²ÑÐµ Ñ„Ð¸Ð»ÑŒÐ¼Ñ‹
php artisan tinker
>>> App\Models\Movie::all()->each(fn($movie) => dispatch(new App\Jobs\IndexModelToElasticsearch($movie)));
```
