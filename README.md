# Movie Search API

Laravel-–ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –¥–ª—è –ø–æ–∏—Å–∫–∞ —Ñ–∏–ª—å–º–æ–≤ —Å –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ–º Elasticsearch. –ü—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –∏–Ω—Ç–µ–≥—Ä–∏—Ä—É–µ—Ç—Å—è —Å TMDb API –¥–ª—è –∏–º–ø–æ—Ä—Ç–∞ –¥–∞–Ω–Ω—ã—Ö –æ —Ñ–∏–ª—å–º–∞—Ö –∏ –∂–∞–Ω—Ä–∞—Ö.

## –í–æ–∑–º–æ–∂–Ω–æ—Å—Ç–∏

- üîç –ü–æ–ª–Ω–æ—Ç–µ–∫—Å—Ç–æ–≤—ã–π –ø–æ–∏—Å–∫ —Ñ–∏–ª—å–º–æ–≤ –ø–æ –Ω–∞–∑–≤–∞–Ω–∏—é, –æ–ø–∏—Å–∞–Ω–∏—é –∏ –∂–∞–Ω—Ä–∞–º
- üìä –í–∑–≤–µ—à–µ–Ω–Ω—ã–π –ø–æ–∏—Å–∫ —Å –Ω–∞—Å—Ç—Ä–∞–∏–≤–∞–µ–º—ã–º–∏ –∫–æ—ç—Ñ—Ñ–∏—Ü–∏–µ–Ω—Ç–∞–º–∏ —Ä–µ–ª–µ–≤–∞–Ω—Ç–Ω–æ—Å—Ç–∏
- üé¨ –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å TMDb API –¥–ª—è –∏–º–ø–æ—Ä—Ç–∞ –ø–æ–ø—É–ª—è—Ä–Ω—ã—Ö —Ñ–∏–ª—å–º–æ–≤
- üè∑Ô∏è –ü–æ–¥–¥–µ—Ä–∂–∫–∞ –ø–æ–∏—Å–∫–∞ –ø–æ —Å–≤—è–∑–∞–Ω–Ω—ã–º –∂–∞–Ω—Ä–∞–º
- ‚ö° –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è –∏–Ω–¥–µ–∫—Å–∞—Ü–∏—è –≤ Elasticsearch –ø—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏/–æ–±–Ω–æ–≤–ª–µ–Ω–∏–∏ –∑–∞–ø–∏—Å–µ–π
- üìÑ –ü–∞–≥–∏–Ω–∞—Ü–∏—è —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤ –ø–æ–∏—Å–∫–∞

## –¢—Ä–µ–±–æ–≤–∞–Ω–∏—è

- PHP 8.1+
- Laravel 10+
- Elasticsearch 7.x/8.x
- Composer

## –£—Å—Ç–∞–Ω–æ–≤–∫–∞

### 1. –ö–ª–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ –∏ —É—Å—Ç–∞–Ω–æ–≤–∫–∞ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π

```bash
git clone https://github.com/MelomiLight/elasticsearch-laravel.git
cd movie-search-api
composer install
```

### 2. –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –æ–∫—Ä—É–∂–µ–Ω–∏—è

–°–∫–æ–ø–∏—Ä—É–π—Ç–µ —Ñ–∞–π–ª –æ–∫—Ä—É–∂–µ–Ω–∏—è –∏ –Ω–∞—Å—Ç—Ä–æ–π—Ç–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ:

```bash
cp .env.example .env
php artisan key:generate
```

### 3. –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö –æ–∫—Ä—É–∂–µ–Ω–∏—è

–î–æ–±–∞–≤—å—Ç–µ –≤ `.env` —Ñ–∞–π–ª —Å–ª–µ–¥—É—é—â–∏–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ:

```env
# Elasticsearch
ELASTICSEARCH_HOST=http://localhost:9200

# TMDb API
TMDB_API_KEY=your_tmdb_api_key_here

# Database
DB_CONNECTION=mysql
DB_HOST=127.0.0.1
DB_PORT=3306
DB_DATABASE=movie_search
DB_USERNAME=your_username
DB_PASSWORD=your_password
```

### 4. –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö

```bash
php artisan migrate
```

### 5. –ó–∞–ø—É—Å–∫ Elasticsearch

–£–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ Elasticsearch –∑–∞–ø—É—â–µ–Ω –∏ –¥–æ—Å—Ç—É–ø–µ–Ω –ø–æ –∞–¥—Ä–µ—Å—É, —É–∫–∞–∑–∞–Ω–Ω–æ–º—É –≤ `ELASTICSEARCH_HOST`.

## –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ

### –ò–º–ø–æ—Ä—Ç –¥–∞–Ω–Ω—ã—Ö

#### –ò–º–ø–æ—Ä—Ç –∂–∞–Ω—Ä–æ–≤ –∏–∑ TMDb:

```bash
php artisan genres:import
```

#### –ò–º–ø–æ—Ä—Ç –ø–æ–ø—É–ª—è—Ä–Ω—ã—Ö —Ñ–∏–ª—å–º–æ–≤ –∏–∑ TMDb:

```bash
php artisan movies:import-popular
```

–≠—Ç–∞ –∫–æ–º–∞–Ω–¥–∞ –∏–º–ø–æ—Ä—Ç–∏—Ä—É–µ—Ç –ø–µ—Ä–≤—ã–µ 10 —Å—Ç—Ä–∞–Ω–∏—Ü –ø–æ–ø—É–ª—è—Ä–Ω—ã—Ö —Ñ–∏–ª—å–º–æ–≤ (~200 —Ñ–∏–ª—å–º–æ–≤).

### API Endpoints

#### –ü–æ–∏—Å–∫ —Ñ–∏–ª—å–º–æ–≤

```http
GET /api/V1/movies/search
```

**–ü–∞—Ä–∞–º–µ—Ç—Ä—ã –∑–∞–ø—Ä–æ—Å–∞:**

- `query` (string, –æ–±—è–∑–∞—Ç–µ–ª—å–Ω—ã–π) - –ø–æ–∏—Å–∫–æ–≤—ã–π –∑–∞–ø—Ä–æ—Å
- `page` (integer, –æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω—ã–π) - –Ω–æ–º–µ—Ä —Å—Ç—Ä–∞–Ω–∏—Ü—ã (–ø–æ —É–º–æ–ª—á–∞–Ω–∏—é: 1)
- `perPage` (integer, –æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω—ã–π) - –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤ –Ω–∞ —Å—Ç—Ä–∞–Ω–∏—Ü–µ (–ø–æ —É–º–æ–ª—á–∞–Ω–∏—é: 10)

**–ü—Ä–∏–º–µ—Ä –∑–∞–ø—Ä–æ—Å–∞:**

```bash
curl "http://localhost:8000/api/V1/movies/search?query=spider&page=1&perPage=5"
```

**–ü—Ä–∏–º–µ—Ä –æ—Ç–≤–µ—Ç–∞:**

```json
{
  "data": {
    "movies": [
      {
        "id": 1,
        "tmdb_id": 557,
        "title": "Spider-Man",
        "overview": "After being bitten by a genetically altered spider...",
        "release_date": "2002-05-01",
        "poster_path": "/gh4cZbhZxyTbgxQPxD0dOudNPTn.jpg",
        "vote_average": 7.2,
        "vote_count": 13507,
        "genres": [
          {
            "id": 1,
            "name": "Action"
          },
          {
            "id": 2,
            "name": "Fantasy"
          }
        ]
      }
    ]
  }
}
```

## –ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞ –ø–æ–∏—Å–∫–∞

### –ü–æ–∏—Å–∫–æ–≤—ã–µ –ø–æ–ª—è –∏ –≤–µ—Å–∞

–ü–æ–∏—Å–∫ –≤—ã–ø–æ–ª–Ω—è–µ—Ç—Å—è –ø–æ —Å–ª–µ–¥—É—é—â–∏–º –ø–æ–ª—è–º —Å —É–∫–∞–∑–∞–Ω–Ω—ã–º–∏ –≤–µ—Å–∞–º–∏:

- `title` (–≤–µ—Å: 3) - –Ω–∞–∑–≤–∞–Ω–∏–µ —Ñ–∏–ª—å–º–∞
- `overview` (–≤–µ—Å: 1) - –æ–ø–∏—Å–∞–Ω–∏–µ —Ñ–∏–ª—å–º–∞
- `genres.name` (–≤–µ—Å: 2) - –Ω–∞–∑–≤–∞–Ω–∏—è –∂–∞–Ω—Ä–æ–≤

### –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è –∏–Ω–¥–µ–∫—Å–∞—Ü–∏—è

–ü—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç trait `ESearchable`, –∫–æ—Ç–æ—Ä—ã–π –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏:

- –ò–Ω–¥–µ–∫—Å–∏—Ä—É–µ—Ç –º–æ–¥–µ–ª–∏ –≤ Elasticsearch –ø—Ä–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–∏
- –£–¥–∞–ª—è–µ—Ç –¥–æ–∫—É–º–µ–Ω—Ç—ã –∏–∑ –∏–Ω–¥–µ–∫—Å–∞ –ø—Ä–∏ —É–¥–∞–ª–µ–Ω–∏–∏ –º–æ–¥–µ–ª–µ–π
- –ò—Å–ø–æ–ª—å–∑—É–µ—Ç Laravel Jobs –¥–ª—è –∞—Å–∏–Ω—Ö—Ä–æ–Ω–Ω–æ–π –æ–±—Ä–∞–±–æ—Ç–∫–∏

### –°—Ç—Ä—É–∫—Ç—É—Ä–∞ –∏–Ω–¥–µ–∫—Å–∞

–ö–∞–∂–¥—ã–π —Ñ–∏–ª—å–º –∏–Ω–¥–µ–∫—Å–∏—Ä—É–µ—Ç—Å—è –≤ Elasticsearch —Å–æ —Å–ª–µ–¥—É—é—â–µ–π —Å—Ç—Ä—É–∫—Ç—É—Ä–æ–π:

```json
{
  "title": "Spider-Man",
  "overview": "After being bitten by a genetically altered spider...",
  "genres": [
    {"name": "Action"},
    {"name": "Fantasy"}
  ]
}
```

## –ú–æ–¥–µ–ª–∏

### Movie

–û—Å–Ω–æ–≤–Ω–∞—è –º–æ–¥–µ–ª—å —Ñ–∏–ª—å–º–∞ —Å –ø–æ–ª—è–º–∏:

- `tmdb_id` - ID —Ñ–∏–ª—å–º–∞ –≤ TMDb
- `title` - –Ω–∞–∑–≤–∞–Ω–∏–µ
- `overview` - –æ–ø–∏—Å–∞–Ω–∏–µ
- `release_date` - –¥–∞—Ç–∞ –≤—ã—Ö–æ–¥–∞
- `poster_path` - –ø—É—Ç—å –∫ –ø–æ—Å—Ç–µ—Ä—É
- `vote_average` - —Å—Ä–µ–¥–Ω—è—è –æ—Ü–µ–Ω–∫–∞
- `vote_count` - –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –≥–æ–ª–æ—Å–æ–≤

### Genre

–ú–æ–¥–µ–ª—å –∂–∞–Ω—Ä–∞:

- `tmdb_id` - ID –∂–∞–Ω—Ä–∞ –≤ TMDb
- `name` - –Ω–∞–∑–≤–∞–Ω–∏–µ –∂–∞–Ω—Ä–∞

## –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è

### Elasticsearch

–ù–∞—Å—Ç—Ä–æ–π–∫–∏ Elasticsearch –Ω–∞—Ö–æ–¥—è—Ç—Å—è –≤ `config/services.php`:

```php
'elasticsearch' => [
    'hosts' => [
        env('ELASTICSEARCH_HOST', 'http://localhost:9200')
    ],
],
```

### –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –ø–æ–∏—Å–∫–∞

–î–ª—è –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –ø–æ–∏—Å–∫–æ–≤—ã—Ö –ø–æ–ª–µ–π –∏ –∏—Ö –≤–µ—Å–æ–≤ –æ—Ç—Ä–µ–¥–∞–∫—Ç–∏—Ä—É–π—Ç–µ —Å–≤–æ–π—Å—Ç–≤–∞ –≤ –º–æ–¥–µ–ª–∏ `Movie`:

```php
protected static array $esSearchableFields = [
    'title' => 3,        // –í–µ—Å –¥–ª—è –Ω–∞–∑–≤–∞–Ω–∏—è
    'overview' => 1,     // –í–µ—Å –¥–ª—è –æ–ø–∏—Å–∞–Ω–∏—è
];

protected static array $esSearchableRelations = [
    'genres' => [
        'name' => 2,     // –í–µ—Å –¥–ª—è –Ω–∞–∑–≤–∞–Ω–∏–π –∂–∞–Ω—Ä–æ–≤
    ],
];
```

## –†–∞–∑—Ä–∞–±–æ—Ç–∫–∞

### –ó–∞–ø—É—Å–∫ –æ—á–µ—Ä–µ–¥–µ–π

–î–ª—è –æ–±—Ä–∞–±–æ—Ç–∫–∏ –∑–∞–¥–∞–Ω–∏–π –∏–Ω–¥–µ–∫—Å–∞—Ü–∏–∏ –∑–∞–ø—É—Å—Ç–∏—Ç–µ worker:

```bash
php artisan queue:work
```

### –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ

```bash
php artisan test
```

## –£—Å—Ç—Ä–∞–Ω–µ–Ω–∏–µ –Ω–µ–ø–æ–ª–∞–¥–æ–∫

### Elasticsearch –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω

–£–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ:

1. Elasticsearch –∑–∞–ø—É—â–µ–Ω –∏ –¥–æ—Å—Ç—É–ø–µ–Ω
2. –ü—Ä–∞–≤–∏–ª—å–Ω–æ —É–∫–∞–∑–∞–Ω `ELASTICSEARCH_HOST` –≤ `.env`
3. –ù–µ—Ç –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–π —Ñ–∞–π—Ä–≤–æ–ª–∞

### –û—à–∏–±–∫–∏ –∏–Ω–¥–µ–∫—Å–∞—Ü–∏–∏

–ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ª–æ–≥–∏ Laravel:

```bash
tail -f storage/logs/laravel.log
```

### –ü–µ—Ä–µ—Å–æ–∑–¥–∞–Ω–∏–µ –∏–Ω–¥–µ–∫—Å–∞

–ï—Å–ª–∏ –Ω—É–∂–Ω–æ –ø–µ—Ä–µ—Å–æ–∑–¥–∞—Ç—å –∏–Ω–¥–µ–∫—Å Elasticsearch:

```bash
# –£–¥–∞–ª–∏—Ç—å –∏–Ω–¥–µ–∫—Å (–∑–∞–º–µ–Ω–∏—Ç–µ 'movies' –Ω–∞ –∏–º—è –≤–∞—à–µ–≥–æ –∏–Ω–¥–µ–∫—Å–∞)
curl -X DELETE "localhost:9200/movies"

# –ü–µ—Ä–µ–∏–Ω–¥–µ–∫—Å–∏—Ä–æ–≤–∞—Ç—å –≤—Å–µ —Ñ–∏–ª—å–º—ã
php artisan tinker
>>> App\Models\Movie::all()->each(fn($movie) => dispatch(new App\Jobs\IndexModelToElasticsearch($movie)));
```

## –õ–∏—Ü–µ–Ω–∑–∏—è

MIT License
